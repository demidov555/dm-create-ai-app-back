from typing import Any, Dict, List
from autogen_agentchat.base import TaskResult
from autogen_agentchat.messages import TextMessage
from autogen_core.models import RequestUsage

ai_command = {
    "__class__": "TaskResult",
    "messages": [
        {
            "__class__": "TextMessage",
            "source": "user",
            "models_usage": "null",
            "metadata": {},
            "content": 'ТЫ — автономная команда из 2 независимых специалистов.\n\nТЕХНИЧЕСКОЕ ЗАДАНИЕ:\nТребования для frontend:\nСоздай красивый сайт для кафе "Уют".\n\nТребования:\n- Современный, тёплый стиль\n- Шрифт: Google Fonts — "Playfair Display" для заголовков, "Open Sans" для текста\n\nСтруктура:\n1. **Хедер**:\n   - Логотип слева: "Уют" (в красивом шрифте)\n   - Меню справа: Главная | Меню | О нас | Контакты\n\n2. **Страница Главная** (полноэкранная):\n   - Фон: мягкое фото кофейни (размытое)\n   - Заголовок: "Добро пожаловать в Уют"\n   - Остальное придумай сам\n\n3. **Страница "Меню"**:\n   - 3 карточки: Кофе, Десерты, Напитки\n   - По 3 примера в каждой (название + цена)\n   - При наведении — лёгкая анимация (подъём карточки)\n\n4. **Страница "О нас"**:\n   - Сгенерируй 2 абзаца о кафе Уют, его истории и атмосфере\n\n5. **Футер**:\n   - Адрес: г. Москва, ул. Пушкина, 10\n   - Телефон: +7 (999) 123-45-67\n   - Соцсети: иконки Instagram, VK\n   - Копирайт: © 2025 Уют\n\nТребования для backend:\n- Напиши вывод в консоле Hello world\n\nТЗ завершено!\n\nТЫ — ТОЛЬКО ОДИН ИЗ НИХ. Твоя роль указана в имени.\n\nРОЛИ В КОМАНДЕ (пиши ГОТОВО ровно так же):\n• Frontend\n• Backend\n\nТЫ ДОЛЖЕН СДЕЛАТЬ ТОЛЬКО ДВЕ ВЕЩИ:\n1. Вывести JSON-массив со СВОИМИ файлами (один раз)\n2. После этого — ровно одну строку: ГОТОВО: ТвояРоль\n\nПРИМЕРЫ ПРАВИЛЬНЫХ СТРОК:\nГОТОВО: Frontend\nГОТОВО: Backend\n\nСТРОГО ЗАПРЕЩЕНО:\n- Писать за других участников\n- Повторять свои файлы\n- Выводить любые токены вроде <|TEAM_COMPLETE|>, <end>, DONE и т.п.\n- Писать что-либо после строки ГОТОВО: ...\n\nСИСТЕМА САМА ЗАВЕРШИТ РАБОТУ, КОГДА УВИДИТ ВСЕ СТРОКИ ГОТОВО.\nТЕБЕ НЕ НУЖНО НИЧЕГО ДЕЛАТЬ ДЛЯ ЭТОГО.\n\nНачинай прямо сейчас.',
            "type": "TextMessage",
        },
        {
            "__class__": "TextMessage",
            "source": "Frontend",
            "models_usage": {
                "__class__": "RequestUsage",
                "prompt_tokens": 2165,
                "completion_tokens": 9472,
            },
            "metadata": {},
            "content": '```json\n{\n  "create": [\n    {\n      "path": "frontend/package.json",\n      "content": "{\\n  \\"name\\": \\"project-iE_ghT-frontend\\",\\n  \\"version\\": \\"1.0.0\\",\\n  \\"private\\": true,\\n  \\"type\\": \\"module\\",\\n  \\"scripts\\": {\\n    \\"dev\\": \\"vite\\",\\n    \\"build\\": \\"vite build\\",\\n    \\"preview\\": \\"vite preview\\"\\n  },\\n  \\"dependencies\\": {\\n    \\"react\\": \\"^18.2.0\\",\\n    \\"react-dom\\": \\"^18.2.0\\",\\n    \\"react-router-dom\\": \\"^6.22.0\\"\\n  },\\n  \\"devDependencies\\": {\\n    \\"@types/react\\": \\"^18.2.15\\",\\n    \\"@types/react-dom\\": \\"^18.2.7\\",\\n    \\"@vitejs/plugin-react\\": \\"^4.2.0\\",\\n    \\"typescript\\": \\"^5.3.3\\",\\n    \\"vite\\": \\"^5.1.0\\"\\n  }\\n}\\n"\n    },\n    {\n      "path": "frontend/tsconfig.json",\n      "content": "{\\n  \\"compilerOptions\\": {\\n    \\"target\\": \\"ESNext\\",\\n    \\"useDefineForClassFields\\": true,\\n    \\"lib\\": [\\"DOM\\", \\"DOM.Iterable\\", \\"ESNext\\"],\\n    \\"allowJs\\": false,\\n    \\"skipLibCheck\\": true,\\n    \\"esModuleInterop\\": false,\\n    \\"allowSyntheticDefaultImports\\": true,\\n    \\"strict\\": true,\\n    \\"forceConsistentCasingInFileNames\\": true,\\n    \\"module\\": \\"ESNext\\",\\n    \\"moduleResolution\\": \\"Node\\",\\n    \\"resolveJsonModule\\": true,\\n    \\"isolatedModules\\": true,\\n    \\"noEmit\\": true,\\n    \\"jsx\\": \\"react-jsx\\"\\n  },\\n  \\"include\\": [\\"src\\"],\\n  \\"references\\": [{ \\"path\\": \\"./tsconfig.node.json\\" }]\\n}\\n"\n    },\n    {\n      "path": "frontend/tsconfig.node.json",\n      "content": "{\\n  \\"compilerOptions\\": {\\n    \\"composite\\": true,\\n    \\"module\\": \\"ESNext\\",\\n    \\"moduleResolution\\": \\"Node\\",\\n    \\"target\\": \\"ESNext\\",\\n    \\"types\\": [\\"node\\"]\\n  },\\n  \\"include\\": [\\"vite.config.ts\\"]\\n}\\n"\n    },\n    {\n      "path": "frontend/vite.config.ts",\n      "content": "import { defineConfig } from \'vite\';\\nimport react from \'@vitejs/plugin-react\';\\n\\nexport default defineConfig({\\n  base: \'/project-iE_ghT/\',\\n  plugins: [react()]\\n});\\n"\n    },\n    {\n      "path": "frontend/index.html",\n      "content": "<!DOCTYPE html>\\n<html lang=\\"ru\\">\\n  <head>\\n    <meta charset=\\"UTF-8\\" />\\n    <link rel=\\"icon\\" href=\\"/favicon.ico\\" />\\n    <meta name=\\"viewport\\" content=\\"width=device-width, initial-scale=1.0\\" />\\n    <title>Кафе Уют</title>\\n    <link href=\\"https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Playfair+Display:wght@700&display=swap\\" rel=\\"stylesheet\\" />\\n  </head>\\n  <body>\\n    <div id=\\"root\\"></div>\\n    <script type=\\"module\\" src=\\"/src/main.tsx\\"></script>\\n  </body>\\n</html>\\n"\n    },\n    {\n      "path": "frontend/src/main.tsx",\n      "content": "import React from \'react\';\\nimport ReactDOM from \'react-dom/client\';\\nimport App from \'./App\';\\nimport \'./index.css\';\\n\\nReactDOM.createRoot(document.getElementById(\'root\') as HTMLElement).render(\\n  <React.StrictMode>\\n    <App />\\n  </React.StrictMode>\\n);\\n"\n    },\n    {\n      "path": "frontend/src/App.tsx",\n      "content": "import { BrowserRouter, Routes, Route } from \'react-router-dom\';\\nimport Header from \'./components/Header\';\\nimport Footer from \'./components/Footer\';\\nimport Home from \'./pages/Home\';\\nimport Menu from \'./pages/Menu\';\\nimport About from \'./pages/About\';\\nimport Contacts from \'./pages/Contacts\';\\nimport \'./App.css\';\\n\\nfunction App() {\\n  return (\\n    <BrowserRouter basename=\\"/project-iE_ghT\\">\\n      <div className=\\"app\\">\\n        <Header />\\n        <main className=\\"content\\">\\n          <Routes>\\n            <Route path=\\"/\\" element={<Home />} />\\n            <Route path=\\"/menu\\" element={<Menu />} />\\n            <Route path=\\"/about\\" element={<About />} />\\n            <Route path=\\"/contacts\\" element={<Contacts />} />\\n          </Routes>\\n        </main>\\n        <Footer />\\n      </div>\\n    </BrowserRouter>\\n  );\\n}\\n\\nexport default App;\\n"\n    },\n    {\n      "path": "frontend/src/components/Header.tsx",\n      "content": "import { Link, useLocation } from \'react-router-dom\';\\nimport \'./Header.css\';\\n\\nconst Header = () => {\\n  const location = useLocation();\\n\\n  const navItems = [\\n    { path: \'/\', label: \'Главная\' },\\n    { path: \'/menu\', label: \'Меню\' },\\n    { path: \'/about\', label: \'О нас\' },\\n    { path: \'/contacts\', label: \'Контакты\' }\\n  ];\\n\\n  return (\\n    <header className=\\"header\\">\\n      <div className=\\"header__logo\\">Уют</div>\\n      <nav className=\\"header__nav\\">\\n        {navItems.map(item => (\\n          <Link\\n            key={item.path}\\n            to={item.path}\\n            className={location.pathname === item.path ? \'active\' : \'\'}\\n          >\\n            {item.label}\\n          </Link>\\n        ))}\\n      </nav>\\n    </header>\\n  );\\n};\\n\\nexport default Header;\\n"\n    },\n    {\n      "path": "frontend/src/components/Header.css",\n      "content": ".header{\\n  display:flex;\\n  justify-content:space-between;\\n  align-items:center;\\n  padding:20px 40px;\\n  background-color:#fff;\\n  box-shadow:0 2px 4px rgba(0,0,0,0.05);\\n  position:sticky;\\n  top:0;\\n  z-index:100;\\n}\\n\\n.header__logo{\\n  font-family:\'Playfair Display\', serif;\\n  font-size:28px;\\n  font-weight:700;\\n  color:#8B4513;\\n}\\n\\n.header__nav a{\\n  margin-left:24px;\\n  font-weight:600;\\n  color:#3d3d3d;\\n  transition:color .3s;\\n}\\n\\n.header__nav a:hover,\\n.header__nav a.active{\\n  color:#8B4513;\\n}\\n"\n    },\n    {\n      "path": "frontend/src/components/Footer.tsx",\n      "content": "import \'./Footer.css\';\\n\\nconst Footer = () => {\\n  return (\\n    <footer className=\\"footer\\">\\n      <div className=\\"footer__info\\">\\n        <p>г. Москва, ул. Пушкина, 10</p>\\n        <p>\\n          Телефон: <a href=\\"tel:+79991234567\\">+7 (999) 123-45-67</a>\\n        </p>\\n      </div>\\n      <div className=\\"footer__social\\">\\n        <a href=\\"#\\" aria-label=\\"Instagram\\">Instagram</a>\\n        <a href=\\"#\\" aria-label=\\"VK\\">VK</a>\\n      </div>\\n      <div className=\\"footer__copy\\">© 2025 Уют</div>\\n    </footer>\\n  );\\n};\\n\\nexport default Footer;\\n"\n    },\n    {\n      "path": "frontend/src/components/Footer.css",\n      "content": ".footer{\\n  background-color:#f2ece4;\\n  padding:30px 40px;\\n  display:flex;\\n  flex-direction:column;\\n  align-items:center;\\n  text-align:center;\\n  font-size:14px;\\n  color:#3d3d3d;\\n}\\n\\n.footer__social{\\n  margin:10px 0;\\n}\\n\\n.footer__social a{\\n  margin:0 10px;\\n  font-weight:600;\\n  color:#8B4513;\\n}\\n\\n.footer__copy{\\n  margin-top:10px;\\n}\\n"\n    },\n    {\n      "path": "frontend/src/pages/Home.tsx",\n      "content": "import \'./Home.css\';\\n\\nconst Home = () => {\\n  return (\\n    <section className=\\"home\\">\\n      <div className=\\"home__overlay\\">\\n        <h1>Добро пожаловать в Уют</h1>\\n        <p>Лучшее место для вашего отдыха с ароматным кофе и десертами.</p>\\n      </div>\\n    </section>\\n  );\\n};\\n\\nexport default Home;\\n"\n    },\n    {\n      "path": "frontend/src/pages/Home.css",\n      "content": ".home{\\n  min-height:calc(100vh - 160px);\\n  background-image:url(\'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1350&q=80\');\\n  background-size:cover;\\n  background-position:center;\\n  position:relative;\\n}\\n\\n.home::after{\\n  content:\'\';\\n  position:absolute;\\n  inset:0;\\n  background-color:rgba(0,0,0,0.4);\\n}\\n\\n.home__overlay{\\n  position:relative;\\n  z-index:1;\\n  height:100%;\\n  display:flex;\\n  flex-direction:column;\\n  justify-content:center;\\n  align-items:center;\\n  text-align:center;\\n  color:#fff;\\n}\\n\\n.home__overlay h1{\\n  font-size:48px;\\n  margin-bottom:16px;\\n}\\n\\n.home__overlay p{\\n  font-size:20px;\\n  max-width:600px;\\n}\\n"\n    },\n    {\n      "path": "frontend/src/pages/Menu.tsx",\n      "content": "import \'./Menu.css\';\\n\\nconst categories = [\\n  {\\n    title: \'Кофе\',\\n    items: [\\n      { name: \'Эспрессо\', price: \'150 ₽\' },\\n      { name: \'Капучино\', price: \'200 ₽\' },\\n      { name: \'Латте\', price: \'220 ₽\' }\\n    ]\\n  },\\n  {\\n    title: \'Десерты\',\\n    items: [\\n      { name: \'Чизкейк\', price: \'250 ₽\' },\\n      { name: \'Круассан\', price: \'180 ₽\' },\\n      { name: \'Тирамису\', price: \'270 ₽\' }\\n    ]\\n  },\\n  {\\n    title: \'Напитки\',\\n    items: [\\n      { name: \'Чай\', price: \'120 ₽\' },\\n      { name: \'Лимонад\', price: \'160 ₽\' },\\n      { name: \'Смузи\', price: \'210 ₽\' }\\n    ]\\n  }\\n];\\n\\nconst Menu = () => {\\n  return (\\n    <section className=\\"menu-page\\">\\n      <h2>Наше меню</h2>\\n      <div className=\\"menu-page__cards\\">\\n        {categories.map(cat => (\\n          <div className=\\"card\\" key={cat.title}>\\n            <h3>{cat.title}</h3>\\n            <ul>\\n              {cat.items.map(item => (\\n                <li key={item.name}>\\n                  <span>{item.name}</span>\\n                  <span>{item.price}</span>\\n                </li>\\n              ))}\\n            </ul>\\n          </div>\\n        ))}\\n      </div>\\n    </section>\\n  );\\n};\\n\\nexport default Menu;\\n"\n    },\n    {\n      "path": "frontend/src/pages/Menu.css",\n      "content": ".menu-page{\\n  padding:60px 40px;\\n}\\n\\n.menu-page h2{\\n  text-align:center;\\n  margin-bottom:40px;\\n}\\n\\n.menu-page__cards{\\n  display:flex;\\n  flex-wrap:wrap;\\n  justify-content:center;\\n  gap:24px;\\n}\\n\\n.card{\\n  background-color:#fff;\\n  border-radius:12px;\\n  box-shadow:0 4px 6px rgba(0,0,0,0.1);\\n  width:280px;\\n  padding:24px;\\n  transition:transform .3s, box-shadow .3s;\\n}\\n\\n.card:hover{\\n  transform:translateY(-10px);\\n  box-shadow:0 8px 12px rgba(0,0,0,0.15);\\n}\\n\\n.card h3{\\n  margin-bottom:16px;\\n  text-align:center;\\n}\\n\\n.card ul{\\n  list-style:none;\\n  padding:0;\\n  margin:0;\\n}\\n\\n.card li{\\n  display:flex;\\n  justify-content:space-between;\\n  margin-bottom:8px;\\n}\\n"\n    },\n    {\n      "path": "frontend/src/pages/About.tsx",\n      "content": "import \'./About.css\';\\n\\nconst About = () => {\\n  return (\\n    <section className=\\"about\\">\\n      <h2>О нас</h2>\\n      <p>Кафе «Уют» открыло свои двери в самом сердце Москвы, чтобы подарить гостям тёплую атмосферу и вкус незабываемого кофе. Начиная с небольшой семейной кофейни, мы сохранили лучшие традиции гостеприимства и любви к качественным зернам.</p>\\n      <p>Сегодня «Уют» — это место, где встречаются друзья, где можно скрыться от городской суеты и насладиться авторскими десертами. Мы заботимся о каждом госте и с радостью делимся частичкой тепла вместе с ароматом свежеобжаренного кофе.</p>\\n    </section>\\n  );\\n};\\n\\nexport default About;\\n"\n    },\n    {\n      "path": "frontend/src/pages/About.css",\n      "content": ".about{\\n  max-width:800px;\\n  margin:0 auto;\\n  padding:60px 20px;\\n  line-height:1.6;\\n}\\n\\n.about h2{\\n  text-align:center;\\n  margin-bottom:32px;\\n}\\n"\n    },\n    {\n      "path": "frontend/src/pages/Contacts.tsx",\n      "content": "import \'./Contacts.css\';\\n\\nconst Contacts = () => {\\n  return (\\n    <section className=\\"contacts\\">\\n      <h2>Контакты</h2>\\n      <p>Мы всегда рады вашим вопросам и предложениям!</p>\\n      <p>Адрес: г. Москва, ул. Пушкина, 10</p>\\n      <p>Телефон: <a href=\\"tel:+79991234567\\">+7 (999) 123-45-67</a></p>\\n      <p>Email: cafe@uyut.ru</p>\\n    </section>\\n  );\\n};\\n\\nexport default Contacts;\\n"\n    },\n    {\n      "path": "frontend/src/pages/Contacts.css",\n      "content": ".contacts{\\n  max-width:800px;\\n  margin:0 auto;\\n  padding:60px 20px;\\n  text-align:center;\\n}\\n\\n.contacts h2{\\n  margin-bottom:24px;\\n}\\n"\n    },\n    {\n      "path": "frontend/src/App.css",\n      "content": ".app{\\n  display:flex;\\n  flex-direction:column;\\n  min-height:100vh;\\n}\\n\\n.content{\\n  flex:1;\\n}\\n"\n    },\n    {\n      "path": "frontend/src/index.css",\n      "content": "body{\\n  margin:0;\\n  font-family:\'Open Sans\', sans-serif;\\n  color:#3d3d3d;\\n  background-color:#fffaf7;\\n}\\n\\na{\\n  text-decoration:none;\\n  color:inherit;\\n}\\n\\nh1,h2,h3{\\n  font-family:\'Playfair Display\', serif;\\n  margin:0;\\n}\\n\\n*{\\n  box-sizing:border-box;\\n}\\n"\n    },\n    {\n      "path": "frontend/src/declarations.d.ts",\n      "content": "declare module \'*.css\' {\\n  const content: { [className: string]: string };\\n  export default content;\\n}\\n\\ndeclare module \'*.svg\' {\\n  const src: string;\\n  export default src;\\n}\\n\\ndeclare module \'*.jpg\' {\\n  const src: string;\\n  export default src;\\n}\\n\\ndeclare module \'*.png\' {\\n  const src: string;\\n  export default src;\\n}\\n"\n    }\n  ],\n  "update": [],\n  "delete": []\n}\n```\n\nГОТОВО: Frontend',
            "type": "TextMessage",
        },
        {
            "__class__": "TextMessage",
            "source": "Backend",
            "models_usage": {
                "__class__": "RequestUsage",
                "prompt_tokens": 5921,
                "completion_tokens": 492,
            },
            "metadata": {},
            "content": '{\n  "create": [\n    {\n      "path": "backend/requirements.txt",\n      "content": "fastapi==0.110.0\\nuvicorn[standard]==0.27.1\\n"\n    },\n    {\n      "path": "backend/main.py",\n      "content": "from fastapi import FastAPI\\n\\napp = FastAPI()\\n\\n\\n@app.on_event(\\"startup\\")\\nasync def startup_event():\\n    print(\\"Hello world\\")\\n\\n\\n@app.get(\\"/\\")\\nasync def read_root():\\n    return {\\"message\\": \\"Hello world\\"}\\n\\n\\nif __name__ == \\"__main__\\":\\n    import uvicorn\\n\\n    uvicorn.run(\\"main:app\\", host=\\"0.0.0.0\\", port=8000, reload=True)\\n"\n    },\n    {\n      "path": "backend/__init__.py",\n      "content": ""\n    }\n  ],\n  "update": [],\n  "delete": []\n}\nГОТОВО: Backend',
            "type": "TextMessage",
        },
    ],
    "stop_reason": "<|TEAM_COMPLETE|>",
}


def create_mock_task_result(
    messages_data: List[Dict[str, Any]], stop_reason: str = "<|TEAM_COMPLETE|>"
) -> TaskResult:
    """
    Создаёт настоящий TaskResult из муляжа.
    Работает с Pydantic v2 — никаких ошибок валидации.
    """
    messages = []

    for msg_data in messages_data:
        # Исправляем models_usage — "null" → None
        models_usage_raw = msg_data.get("models_usage")
        if models_usage_raw == "null" or models_usage_raw == "string_null_placeholder":
            models_usage = None
        elif isinstance(models_usage_raw, dict) and "__class__" in models_usage_raw:
            # Если там вложенный RequestUsage — создаём настоящий объект
            usage_data = models_usage_raw.copy()
            usage_data.pop("__class__", None)
            models_usage = RequestUsage(**usage_data)
        else:
            models_usage = models_usage_raw  # уже нормальный dict или None

        # Создаём настоящий TextMessage
        msg = TextMessage(
            source=msg_data["source"],
            content=msg_data["content"],
            models_usage=models_usage,
            metadata=msg_data.get("metadata", {}),
        )
        messages.append(msg)

    return TaskResult(messages=messages, stop_reason=stop_reason)


mock = create_mock_task_result(ai_command["messages"], ai_command["stop_reason"])
